<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BID System - Verifier Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.1/ethers.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { 
            max-width: 900px; 
            margin: 0 auto; 
            background: white; 
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header { 
            background: linear-gradient(135deg, #00b09b, #96c93d); 
            color: white; 
            padding: 30px; 
            text-align: center;
        }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .header p { opacity: 0.9; font-size: 1.1em; }
        .content { padding: 40px; }
        .section { 
            margin: 30px 0; 
            padding: 25px; 
            border: 2px solid #f0f0f0; 
            border-radius: 15px;
            transition: all 0.3s ease;
        }
        .section:hover { border-color: #00b09b; transform: translateY(-2px); }
        .section h3 { color: #333; margin-bottom: 15px; font-size: 1.4em; }
        .form-group { margin: 15px 0; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #555; }
        .form-group input { 
            width: 100%; 
            padding: 12px; 
            border: 2px solid #ddd; 
            border-radius: 8px; 
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        .form-group input:focus { 
            outline: none; 
            border-color: #00b09b; 
            box-shadow: 0 0 0 3px rgba(0,176,155,0.1);
        }
        button { 
            background: linear-gradient(135deg, #00b09b, #96c93d); 
            color: white; 
            border: none; 
            padding: 12px 25px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 16px; 
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 10px 5px;
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,176,155,0.4); }
        button:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .status { 
            padding: 15px; 
            border-radius: 8px; 
            margin: 15px 0; 
            font-weight: 600;
        }
        .verified { background: #e8f5e8; color: #2e7d32; border: 1px solid #4caf50; }
        .not-verified { background: #ffebee; color: #c62828; border: 1px solid #f44336; }
        .info { background: #e3f2fd; color: #1565c0; border: 1px solid #2196f3; }
        .warning { background: #fff3e0; color: #ef6c00; border: 1px solid #ff9800; }
        .wallet-info { 
            background: #f8f9fa; 
            padding: 20px; 
            border-radius: 10px; 
            margin: 20px 0;
            border-left: 4px solid #00b09b;
        }
        .verification-card {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            transition: all 0.3s ease;
        }
        .verification-card.verified {
            border-color: #4caf50;
            background: linear-gradient(135deg, #e8f5e8, #f1f8e9);
        }
        .verification-card.not-verified {
            border-color: #f44336;
            background: linear-gradient(135deg, #ffebee, #fce4ec);
        }
        .batch-section {
            background: #f3e5f5;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .address-list {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            align-items: center;
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #9c27b0;
        }
        .demo-scenario {
            background: linear-gradient(135deg, #e1bee7, #f8bbd9);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            border: 2px solid #9c27b0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç BID Verifier</h1>
            <p>Verification Dashboard - Check Identity Without Storing Documents</p>
        </div>

        <div class="content">
            <!-- Wallet Connection Section -->
            <div class="section">
                <h3>ü¶ä Connect Wallet</h3>
                <div id="wallet-status" class="info">Connect your wallet to start verifying identities</div>
                <div class="wallet-info" id="wallet-info" style="display: none;">
                    <strong>Connected Account:</strong> <span id="account-address"></span><br>
                    <strong>Network:</strong> <span id="network-name"></span><br>
                    <strong>Role:</strong> <span id="user-role">Identity Verifier</span>
                </div>
                <button onclick="connectWallet()">Connect Wallet</button>
                <button onclick="switchToAmoy()">Switch to Polygon Amoy</button>
            </div>

            <!-- Contract Connection -->
            <div class="section">
                <h3>üìÑ Contract Connection</h3>
                <div class="form-group">
                    <label>BID Contract Address:</label>
                    <input type="text" id="contract-address" placeholder="Paste deployed contract address here">
                    <small style="color: #666;">Get this from your deployment or Remix IDE</small>
                </div>
                <button onclick="loadContract()">Connect to Contract</button>
                <div id="contract-status"></div>
            </div>

            <!-- Demo Scenario -->
            <div class="demo-scenario">
                <h3>üéØ Demo Scenario</h3>
                <p><strong>Imagine you're:</strong> A bank, employer, or service provider who needs to verify someone's identity</p>
                <p><strong>Traditional way:</strong> Ask user to upload ID documents (security risk!)</p>
                <p><strong>BID way:</strong> Just check their wallet address on blockchain (no documents needed!)</p>
            </div>

            <!-- Single Verification Check -->
            <div class="section">
                <h3>üîç Verify Single Identity</h3>
                <div class="form-group">
                    <label>User Wallet Address to Verify:</label>
                    <input type="text" id="verify-address" placeholder="0x...">
                </div>
                <button onclick="verifySingleUser()">üîç Check Verification Status</button>
                <div id="single-verification-result"></div>
            </div>

            <!-- Batch Verification -->
            <div class="section">
                <h3>üìä Batch Verification (Multiple Users)</h3>
                <div class="batch-section">
                    <h4>Test Multiple Addresses at Once:</h4>
                    <div id="batch-addresses">
                        <div class="address-list">
                            <input type="text" placeholder="0x742d35Cc6634C0532925a3b8D8C1C1b2c0b7c4d5" class="batch-address">
                            <button onclick="removeBatchAddress(this)">Remove</button>
                        </div>
                    </div>
                    <button onclick="addBatchAddress()">+ Add Address</button>
                    <button onclick="verifyBatchUsers()">üîç Check All Addresses</button>
                </div>
                <div id="batch-verification-results"></div>
            </div>

            <!-- Quick Demo Addresses -->
            <div class="section">
                <h3>‚ö° Quick Demo</h3>
                <p>Use these pre-filled addresses for testing:</p>
                <div style="display: grid; grid-template-columns: 1fr auto; gap: 10px; margin: 15px 0;">
                    <input type="text" value="0x742d35Cc6634C0532925a3b8D5dFcDaEec7BEA50" readonly>
                    <button onclick="quickCheck(this.previousElementSibling.value)">Quick Check</button>
                </div>
                <div style="display: grid; grid-template-columns: 1fr auto; gap: 10px; margin: 15px 0;">
                    <input type="text" value="0x8ba1f109551bD432803012645Ac136c7136BB53F" readonly>
                    <button onclick="quickCheck(this.previousElementSibling.value)">Quick Check</button>
                </div>
                <div style="display: grid; grid-template-columns: 1fr auto; gap: 10px; margin: 15px 0;">
                    <input type="text" value="0xdD2FD4581271e230360230F9337D5c0430Bf44C0" readonly>
                    <button onclick="quickCheck(this.previousElementSibling.value)">Quick Check</button>
                </div>
            </div>

            <!-- Transaction Status -->
            <div id="transaction-status"></div>
        </div>
    </div>

    <script>
        // Contract ABI for verifier functions
        const CONTRACT_ABI = [
            "function isBIDValid(address user) external view returns (bool)",
            "function getBID(address user) external view returns (tuple(bytes32 hashedPersonalInfo, address issuer, uint256 timestamp, bool isValid, string metadataHash))",
            "function owner() external view returns (address)",
            "function authorizedIssuers(address) external view returns (bool)"
        ];

        let provider;
        let signer;
        let contract;
        let userAccount;

        // Connect to MetaMask
        async function connectWallet() {
            try {
                if (typeof window.ethereum !== 'undefined') {
                    provider = new ethers.BrowserProvider(window.ethereum);
                    await provider.send("eth_requestAccounts", []);
                    signer = await provider.getSigner();
                    userAccount = await signer.getAddress();
                    
                    const network = await provider.getNetwork();
                    
                    document.getElementById('wallet-status').className = 'status verified';
                    document.getElementById('wallet-status').textContent = '‚úÖ Wallet Connected - Ready to Verify Identities!';
                    
                    document.getElementById('account-address').textContent = userAccount;
                    document.getElementById('network-name').textContent = network.name + ' (Chain ID: ' + network.chainId + ')';
                    document.getElementById('wallet-info').style.display = 'block';
                    
                } else {
                    showStatus('‚ùå MetaMask not found! Please install MetaMask to verify identities.', 'not-verified');
                }
            } catch (error) {
                console.error(error);
                showStatus('‚ùå Error connecting wallet: ' + error.message, 'not-verified');
            }
        }

        // Switch to Polygon Amoy testnet
        async function switchToAmoy() {
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: '0x13882' }], // 80002 in hex
                });
            } catch (switchError) {
                if (switchError.code === 4902) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: '0x13882',
                                chainName: 'Polygon Amoy Testnet',
                                nativeCurrency: {
                                    name: 'MATIC',
                                    symbol: 'MATIC',
                                    decimals: 18
                                },
                                rpcUrls: ['https://rpc-amoy.polygon.technology/'],
                                blockExplorerUrls: ['https://amoy.polygonscan.com/']
                            }]
                        });
                    } catch (addError) {
                        console.error('Error adding network:', addError);
                    }
                }
            }
        }

        // Load contract
        async function loadContract() {
            try {
                const contractAddress = document.getElementById('contract-address').value;
                if (!contractAddress) {
                    alert('Please enter contract address');
                    return;
                }

                // Create read-only contract instance (verifiers don't need to sign transactions)
                contract = new ethers.Contract(contractAddress, CONTRACT_ABI, provider);
                
                showStatus('‚úÖ Connected to BID Registry! Ready to verify identities.', 'verified');
                
            } catch (error) {
                console.error(error);
                showStatus('‚ùå Error connecting to contract: ' + error.message, 'not-verified');
            }
        }

        // Verify single user
        async function verifySingleUser() {
            try {
                if (!contract) {
                    alert('Please connect to contract first');
                    return;
                }

                const userAddress = document.getElementById('verify-address').value;
                if (!userAddress) {
                    alert('Please enter user address');
                    return;
                }

                showStatus('üîÑ Checking blockchain for verification...', 'info');

                const isValid = await contract.isBIDValid(userAddress);
                
                let resultHtml = '';
                
                if (isValid) {
                    try {
                        const bidData = await contract.getBID(userAddress);
                        const timestamp = new Date(Number(bidData.timestamp) * 1000);
                        
                        resultHtml = `
                            <div class="verification-card verified">
                                <h4 style="color: #2e7d32; margin-bottom: 15px;">‚úÖ IDENTITY VERIFIED</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 14px;">
                                    <div>
                                        <strong>Verified By:</strong><br>
                                        <code style="background: #e8f5e8; padding: 5px; border-radius: 4px;">${bidData.issuer}</code>
                                    </div>
                                    <div>
                                        <strong>Verification Date:</strong><br>
                                        ${timestamp.toLocaleDateString()} at ${timestamp.toLocaleTimeString()}
                                    </div>
                                    <div>
                                        <strong>Status:</strong><br>
                                        <span style="color: #2e7d32;">‚úÖ Active & Valid</span>
                                    </div>
                                    <div>
                                        <strong>Metadata:</strong><br>
                                        ${bidData.metadataHash || 'None'}
                                    </div>
                                </div>
                                <div style="margin-top: 15px; padding: 10px; background: rgba(46,125,50,0.1); border-radius: 8px;">
                                    <strong>üîí Privacy Note:</strong> Only verification status is stored on blockchain. No personal documents or sensitive data.
                                </div>
                            </div>
                        `;
                    } catch (error) {
                        resultHtml = `
                            <div class="verification-card verified">
                                <h4 style="color: #2e7d32;">‚úÖ IDENTITY VERIFIED</h4>
                                <p>This user has valid BID verification, but details are not accessible from your current role.</p>
                            </div>
                        `;
                    }
                } else {
                    resultHtml = `
                        <div class="verification-card not-verified">
                            <h4 style="color: #c62828; margin-bottom: 15px;">‚ùå IDENTITY NOT VERIFIED</h4>
                            <p><strong>This wallet address has no valid BID verification.</strong></p>
                            <div style="margin-top: 15px; padding: 15px; background: rgba(198,40,40,0.1); border-radius: 8px;">
                                <strong>‚ö†Ô∏è Security Warning:</strong><br>
                                ‚Ä¢ This user has not been verified by any authorized issuer<br>
                                ‚Ä¢ Do not proceed with identity-sensitive operations<br>
                                ‚Ä¢ Recommend user to get verified through proper channels
                            </div>
                        </div>
                    `;
                }
                
                document.getElementById('single-verification-result').innerHTML = resultHtml;
                
            } catch (error) {
                console.error(error);
                showStatus('‚ùå Error during verification: ' + error.message, 'not-verified');
            }
        }

        // Quick check function for demo buttons
        async function quickCheck(address) {
            document.getElementById('verify-address').value = address;
            await verifySingleUser();
        }

        // Add address to batch verification
        function addBatchAddress() {
            const batchContainer = document.getElementById('batch-addresses');
            const newAddressDiv = document.createElement('div');
            newAddressDiv.className = 'address-list';
            newAddressDiv.innerHTML = `
                <input type="text" placeholder="0x..." class="batch-address">
                <button onclick="removeBatchAddress(this)">Remove</button>
            `;
            batchContainer.appendChild(newAddressDiv);
        }

        // Remove address from batch
        function removeBatchAddress(button) {
            button.parentElement.remove();
        }

        // Verify multiple users at once
        async function verifyBatchUsers() {
            try {
                if (!contract) {
                    alert('Please connect to contract first');
                    return;
                }

                const addressInputs = document.querySelectorAll('.batch-address');
                const addresses = Array.from(addressInputs)
                    .map(input => input.value.trim())
                    .filter(addr => addr.length > 0);

                if (addresses.length === 0) {
                    alert('Please enter at least one address');
                    return;
                }

                showStatus(`üîÑ Checking ${addresses.length} addresses on blockchain...`, 'info');

                let resultsHtml = '<h4>üìä Batch Verification Results:</h4>';
                
                for (let i = 0; i < addresses.length; i++) {
                    const address = addresses[i];
                    try {
                        const isValid = await contract.isBIDValid(address);
                        const status = isValid ? '‚úÖ VERIFIED' : '‚ùå NOT VERIFIED';
                        const statusClass = isValid ? 'verified' : 'not-verified';
                        
                        resultsHtml += `
                            <div class="verification-card ${statusClass}" style="margin: 10px 0; padding: 15px;">
                                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 15px; align-items: center;">
                                    <div>
                                        <strong>Address:</strong> <code>${address}</code>
                                    </div>
                                    <div>
                                        <strong>${status}</strong>
                                    </div>
                                </div>
                            </div>
                        `;
                    } catch (error) {
                        resultsHtml += `
                            <div class="verification-card not-verified" style="margin: 10px 0; padding: 15px;">
                                <strong>Address:</strong> <code>${address}</code><br>
                                <strong>‚ùå ERROR:</strong> ${error.message}
                            </div>
                        `;
                    }
                }

                document.getElementById('batch-verification-results').innerHTML = resultsHtml;
                showStatus('‚úÖ Batch verification complete!', 'verified');
                
            } catch (error) {
                console.error(error);
                showStatus('‚ùå Batch verification failed: ' + error.message, 'not-verified');
            }
        }

        // Utility function to show status messages
        function showStatus(message, type) {
            const statusDiv = document.getElementById('transaction-status');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        // Auto-connect if wallet was previously connected
        window.addEventListener('load', async () => {
            if (typeof window.ethereum !== 'undefined') {
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                if (accounts.length > 0) {
                    connectWallet();
                }
            }
        });

        // Listen for account/network changes
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', function (accounts) {
                if (accounts.length === 0) {
                    location.reload();
                } else {
                    connectWallet();
                }
            });

            window.ethereum.on('chainChanged', function (chainId) {
                location.reload();
            });
        }
    </script>
</body>
</html>